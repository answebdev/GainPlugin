name: Build VST3 Plugin for macOS

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: macos-latest  # Use macOS runner for building on macOS
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3  # Checkout the repository to access the code
    
    - name: Install dependencies (Homebrew and JUCE)
      run: |
        # Install Homebrew if it's not installed
        if ! command -v brew &> /dev/null
        then
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        
        # Install JUCE (if not included in the repo)
        if [ ! -d "$HOME/juce" ]; then
          git clone --branch master https://github.com/juce-framework/JUCE.git $HOME/juce
        fi
        
        # Install VST3 SDK (use the VST3_SDK folder in the root of your project)
        echo "Using VST3 SDK from the repository root: $GITHUB_WORKSPACE/VST3_SDK"

    - name: Generate Xcode project using Projucer
      run: |
        cd "$GITHUB_WORKSPACE"
        # Run Projucer to generate the Xcode project from the .jucer file
        "$GITHUB_WORKSPACE/Projucer" --resave "$GITHUB_WORKSPACE/GainPlugin.jucer"
    
    - name: Build VST3 Plugin using Xcode
      run: |
        cd "$GITHUB_WORKSPACE/build"
        # Build the plugin using Xcode CLI
        xcodebuild -project "GainPlugin.xcodeproj" -scheme "GainPlugin" -configuration Release

    - name: Upload built VST3 plugin
      uses: actions/upload-artifact@v3
      with:
        name: gainplugin-vst3
        path: "$GITHUB_WORKSPACE/build/Release/GainPlugin.vst3"
